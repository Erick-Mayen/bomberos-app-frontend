<div
  class="modal-backdrop modify"
  [class.show]="isOpen"
  (click)="onBackdropClick($event)"
  *ngIf="isOpen"
>
  <div class="modal-container" [class.show]="isOpen">
    <div class="personal-card">
      <div class="card-header">
        <div class="header-content">
          <h1 class="card-title">
            <span class="fire-icon"><fa-icon icon="user"></fa-icon></span>
            {{ modalTitle }}
          </h1>
          <button
            type="button"
            class="close-button"
            (click)="onCancel()"
            aria-label="Cerrar modal"
          >
            ✕
          </button>
        </div>
      </div>

      <form
        [formGroup]="userForm"
        (ngSubmit)="onSubmit()"
        class="personal-form"
      >
        <div class="form-grid">
          <!-- Nombre de Usuario -->
          <div class="form-group">
            <label for="nombre_usuario" class="form-label required"
              >Nombre de Usuario</label
            >
            <input
              id="nombre_usuario"
              type="text"
              formControlName="nombre_usuario"
              class="form-input"
              [class.error]="isFieldInvalid('nombre_usuario')"
              placeholder="Ingrese el nombre de usuario"
            />
            <div
              class="error-message"
              *ngIf="getErrorMessage('nombre_usuario')"
            >
              {{ getErrorMessage("nombre_usuario") }}
            </div>
          </div>

          <!-- Contraseña -->
          <div class="form-group">
            <label for="contrasenia" class="form-label required">Contraseña </label>
            <div
              class="input-container"
              [class.error]="isFieldInvalid('contrasenia')"
            >
              <fa-icon [icon]="'lock'" class="input-icon"></fa-icon>

              <input
                [type]="showPassword ? 'text' : 'password'"
                id="contrasenia"
                formControlName="contrasenia"
                class="form-input"
                [readonly]="isPasswordDisabled"
                placeholder="Ingresa la contraseña"
              />

              <button
                *ngIf="!isPasswordDisabled"
                type="button"
                class="password-toggle"
                (click)="togglePassword()"
              >
                <fa-icon
                  [icon]="showPassword ? 'eye-slash' : 'eye'"
                  class="eye-icon"
                ></fa-icon>
              </button>
            </div>

            <div class="error-message" *ngIf="isFieldInvalid('contrasenia')">
              <fa-icon
                [icon]="'exclamation-triangle'"
                class="error-icon"
              ></fa-icon>
              {{ getErrorMessage("contrasenia") }}
            </div>
            <div *ngIf="!userToEdit" class="generate-password">
              <a
                href="#"
                (click)="generatePasswordForNewUser(); $event.preventDefault()"
              >
                Generar contraseña
              </a>
            </div>
            <div *ngIf="isPasswordDisabled" class="reset-password">
              <a href="#" (click)="resetPassword(); $event.preventDefault()"
                >Restablecer contraseña</a
              >
            </div>
          </div>

          <!-- Rol -->
          <div class="form-group">
            <label for="rol" class="form-label required">Rol</label>
            <ng-select
              [items]="roles"
              bindLabel="nombre_rol"
              bindValue="id_rol"
              [placeholder]="
                userForm.get('rol')?.value
                  ? ''
                  : 'Seleccione el rol del usuario'
              "
              formControlName="rol"
              [clearable]="true"
              [searchable]="true"
              [clearSearchOnAdd]="true"
              [class.error]="isFieldInvalid('rol')"
            >
              <ng-template ng-label-tmp let-item="item">
                {{ item.nombre_rol }}
              </ng-template>
              <ng-template ng-option-tmp let-item="item">
                {{ item.nombre_rol }}
              </ng-template>
            </ng-select>
            <div class="error-message" *ngIf="getErrorMessage('rol')">
              {{ getErrorMessage("rol") }}
            </div>
          </div>

          <!-- Personal (opcional) -->
          <div class="form-group">
            <label for="id_personal" class="form-label"
              >Persona Asociada</label
            >
            <ng-select
              [items]="personalList"
              bindLabel="displayName"
              bindValue="id"
              [placeholder]="
                userForm.get('id_personal')?.value
                  ? ''
                  : 'Seleccione un personal'
              "
              formControlName="id_personal"
              [clearable]="true"
              [searchable]="true"
              [clearSearchOnAdd]="true"
            >
              <ng-template ng-label-tmp let-item="item">
                {{ item.primer_nombre }} {{ item.primer_apellido }}
              </ng-template>
              <ng-template ng-option-tmp let-item="item">
                {{ item.primer_nombre }} {{ item.primer_apellido }}
              </ng-template>
            </ng-select>
            <div class="error-message" *ngIf="getErrorMessage('id_personal')">
              {{ getErrorMessage("id_personal") }}
            </div>
          </div>
        </div>

        <!-- Botones -->
        <div class="form-actions">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="onCancel()"
            [disabled]="isSubmitting"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="userForm.invalid || isSubmitting"
          >
            <span *ngIf="!isSubmitting">
              <span class="btn-icon"><fa-icon icon="user"></fa-icon></span>
              {{ submitLabel }}
            </span>
            <span *ngIf="isSubmitting" class="loading-spinner"
              >Guardando...</span
            >
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
